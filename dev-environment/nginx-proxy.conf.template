# SPDX-FileCopyrightText: Magenta ApS <https://magenta.dk>
# SPDX-License-Identifier: MPL-2.0
server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    # proxy_passes MUST use variables to force DNS lookup on every request
    # to allow the proxy to start before all services are initialised.
    resolver 127.0.0.11 valid=5s;  # 127.0.0.11 is the docker DNS server

    # MO Paths
    # This list should correspond with:
    # * https://git.magenta.dk/rammearkitektur/os2mo-helm-chart/-/blob/master/os2mo/templates/mo/ingress.yaml#L29
    # * All the salt pillar ones
    location /openapi.json {
        set $mo mo;
        proxy_pass http://$mo;
    }

    map $http_upgrade $connection_upgrade {
      default upgrade;
      '' close;
    }

    location /graphql {
        set $mo mo;
        proxy_pass http://$mo;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    location /metrics {
        set $mo mo;
        proxy_pass http://$mo;
    }

    location /docs {
        set $mo mo;
        proxy_pass http://$mo;
    }

    location /service/ {
        set $mo mo;
        proxy_pass http://$mo;
    }

    location /version/ {
        set $mo mo;
        proxy_pass http://$mo;
    }

    location /testing/ {
        set $mo mo;
        proxy_pass http://$mo;
    }

    location /lora/ {
        set $mo mo;
        proxy_pass http://$mo;
    }

    location /health/ {
        set $mo mo;
        proxy_pass http://$mo;
    }

    # Keycloak
    location /auth/ {
        set $keycloak keycloak;
        proxy_pass http://$keycloak:8080;
    }

    # New frontend
    location /new {
        set $frontend_new_static frontend_new_static;
        proxy_pass http://$frontend_new_static:3000;
    }

    # Frontend
    # (everything unmatched)
    location / {
        set $frontend_static frontend_static;
        proxy_pass http://$frontend_static;
    }
}
